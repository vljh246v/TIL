# **8. 프록시와 연관관계 관리**

**프록시와 즉시로딩, 지연로딩**

- 객체가 데이터베이스에 저장되어 있으므로 마음껏 객체 탐색을 하기에는 어렵다.
- 그렇기 때문에 프록시라는 기술을 사용해서 실제 사용하는 시점에 데이터베이스에서 조회할 수 있다.

**영속성 전이와 고아 객체**

- 연관된 객체를 함께 저장하거나 함께 삭제할 수 잇는 영속성 전이와 고아 객체 제거라는 편리한 기능을 제공한다.

## **8.1 프록시**

- 필요없는 엔티티 리스트까지 조회해 두는 것은 효율적이지 않다.
- 지연로딩을 사용해서 실제 사용하는 시점에서 조회하는 방법을 사용한다.

### **8.1.1 프록시 기초**

- getReference(엔티티.class, 엔티티 Id) 를 사용하면 데이터베이스를 조회하지 않는 프록시 객체를 가지고 온다.
- 프록시 객체는 실제 객체에 대한 참조를 보관한다.
- 프록시 초기화 과정

  1. 프록시 객체에 엔티티 get 을 호출해서 실제 데이터를 조회한다.
  2. 프록시객체에 실제 엔티티가 생성되어 있찌 않으면 영속성 컨텍스트에 실제 엔티티 생성을 요청하는데 이것을 초기화라고 한다.
  3. 영속성 컨텍스트는 데이터베이스를 조회해서 실제 엔티티 객체를 생성한다.
  4. 프록시 객체는 생성된 실제 엔티티 객체의 참조를 맴버변수에 보관한다.
  5. 프록시 객체는 실제 엔티티 객체의 getter를 호출해서 결과를 반환한다.

- 프록시의 특징
  - 프록시 객체는 처음 사용할 때 한 번만 초기화된다.
  - 프록시 객체를 초기화한다고 프록시 객첵 실제 엔티티로 바뀌는 것은 아니다.
  - 프록시 객체가 초기화되면 프록시 객체를 통해서 실제 엔티티에 접근할 수 있다.
  - 프록시 객체는 원본 엔티티를 상속받은 객체이므로 타입 체크 시에 주의해서 사용해야 한다.
  - 영속성 컨텍스트에 찾는 엔티티가 이미 있으면 데이터베이스를 조회할 필요가 없으므로 em.getReference()를 호출해도 프록시가 아닌 실제 엔티티를 반환 한다.
  - 초기화는 영속성 컨텍스트의 도움을 받아야 가능하다. 그래서 준영속 상태 프록시를 초기화 하면 문제가 발생한다.

### **8.1.2 프록시와 식별자**

- 인티티를 프록시로 조회할 때 식별자 값을 파라미터로 전달
- 프로시 객체는 식별자 값을 가지고 있어 엔티티 접근방식을 필드로 설정하면 식발자 값 getter 를 호출해도 초기화 하지 않는다.
- 연관관계를 설정할 때는 엔티티 접근 방식을 필드로 설정해도 프록시를 초기화하지 않는다.

### **8.1.3 프록시 확인**

- JPA가 제공하는 PersistenceUnitUtil.isLoaded(Object entity) 메소드를 사용하면 프록시 인스턴스의 초기화 여부를 알 수 있다.
- 조회한 엔티티가 진짜 엔티티인지 프록시인지 확인하려면 클래스 명을 출력해 보면 된다.

## **8.2 즉시 로딩과 지연 로딩**

- JPA는 개발자가 연관된 엔티티의 조회 시점을 선택살 수 있도록 두가지 방법을 제공한다.
- **즉시 로딩** : 엔티티를 조회할 때 연관된 엔티티도 함께 조회한다.

  - 예 : me.find(Member.class, "mebmer1")를 호출할 때 회원 엔티티와 연관된 팀 엔티티도 조회한다.
  - 설정 방법 : @ManyToOne(fetch = "FetchType.EAGER")

- **지연 로딩** : 연관된 엔티티를 실제 사용할 때 조회한다.
  - 예 : member.getTeam().getName() 처럼 조회한 팀 엔티티를 실제 사용하는 시점에 JPA가 SQL을 호출해서 팀 엔티티를 조회한다.
  - 설정 방법 : @ManeyToOne(fetch = FetchType.LAZY)

### **8.2.1 즉시 로딩**
- 즉시 로딩을 사용하려면 @ManyToOne 의 fetch 속성을 FetchType.EAGER 로 지정한다.
- @ManyToOne(fetch = FetchType.EAGER)
- JPA 구현체는 즉시 로딩을 최적화 하기위해 가능하면 조인 쿼리를 사용한다.
- NOT NULL 제약조건을 사용하면 실제로 INNER JOIN 을 사용한다.-> 최적화에 유리

### **8.2.2 지연로딩**
- 지연 로딩을 사용하려면 @ManyToOne의 fetch 속성을 FetchType.LAZY 로 지정한다.
- 실제 프록시 객체를 사용해서 사용될 때까지 데이터 로딩을 미룬다.

## **8.3 지연 로딩 활용**
